#require_relative  '../../test_helper'
require 'mocha/setup'
require  'test_helper'

class AxcessmsTest < Test::Unit::TestCase

  @@success_messages = { 
    'CONNECTOR_TEST' => "Successful Processing - Request successfully processed in 'Merchant in Connector Test Mode'",
    'INTEGRATOR_TEST' => "Successful Processing - Request successfully processed in 'Merchant in Integrator Test Mode'",
  }

  @@success_codes = { 
    'CONNECTOR_TEST' => "000.100.112",
    'INTEGRATOR_TEST' => "000.100.112",
  }

  def setup
    @gateway = AxcessmsGateway.new(fixtures(:axcessms))
    @gateway.logger = Logger.new(STDOUT) 
    @gateway.logger.level = Logger::DEBUG

    @credit_card = credit_card('4200000000000000', month: 05, year: 2022)
    @declined_card = credit_card('4444444444444444', month: 05, year: 2022)
    @modemsg = 'Integrator'
    @mode = @modemsg.upcase + '_TEST'
    set_options
  end

  def test_failed_purchase
    @gateway.expects(:ssl_post).returns("TRANSACTION.CHANNEL=channel&PRESENTATION.CURRENCY=EUR&IDENTIFICATION.UNIQUEID=8a82944a475852dc01475fa95e497177&PAYMENT.CODE=CC.DB&FRONTEND.CC_LOGO=images%2Fvisa_mc.gif&PROCESSING.STATUS=REJECTED_VALIDATION&ADDRESS.STREET=Leopoldstr.+1&CONTACT.IP=178.10.199.190&FRONTEND.MODE=DEFAULT&FRONTEND.REQUEST.CANCELLED=false&PROCESSING.RETURN=invalid+creditcard%2C+bank+account+number+or+bank+name&PROCESSING.REASON=Account+Validation&ADDRESS.STATE=BY&PROCESSING.STATUS.CODE=70&TRANSACTION.MODE=#{@mode}&POST.VALIDATION=ACK&PROCESSING.TIMESTAMP=2014-07-22+20%3A00%3A41&NAME.GIVEN=Longbob&ADDRESS.CITY=Munich&PROCESSING.RETURN.CODE=100.100.101&RESPONSE.VERSION=1.0&TRANSACTION.RESPONSE=SYNC&P3.VALIDATION=ACK&PROCESSING.CODE=CC.DB.70.40&FRONTEND.SESSION_ID=&PROCESSING.REASON.CODE=40&NAME.FAMILY=Longsen&PRESENTATION.USAGE=Order+Number+468.64471554756165&IDENTIFICATION.SHORTID=2415.3695.0946&NAME.SALUTATION=NONE&PROCESSING.RESULT=NOK&PRESENTATION.AMOUNT=1.50&IDENTIFICATION.TRANSACTIONID=Ruby-RemoteTest+140605924064.47388&ADDRESS.COUNTRY=DE&ADDRESS.ZIP=80798")

    response = @gateway.purchase(@amount, @credit_card, @options)
    assert_failure response
  end

  def test_successful_purchase
    @gateway.expects(:ssl_post).returns("PROCESSING.RISK_SCORE=100&P3.VALIDATION=ACK&NAME.GIVEN=blabla&CLEARING.DESCRIPTOR=6311.1334.3650+activeMerchant+Order+Number+1920.6604516506195&PROCESSING.CONNECTORDETAIL.ConnectorTxID3=26K00001&PROCESSING.CONNECTORDETAIL.ConnectorTxID1=261858&TRANSACTION.CHANNEL=channel&PROCESSING.REASON.CODE=00&ADDRESS.CITY=Munich&FRONTEND.REQUEST.CANCELLED=false&PROCESSING.CODE=CC.DB.90.00&PROCESSING.REASON=Successful+Processing&FRONTEND.MODE=DEFAULT&CLEARING.FXSOURCE=INTERN&CLEARING.AMOUNT=1.50&PROCESSING.RESULT=ACK&NAME.SALUTATION=NONE&PRESENTATION.USAGE=Order+Number+1920.6604516506195&POST.VALIDATION=ACK&CLEARING.CURRENCY=EUR&FRONTEND.SESSION_ID=&PROCESSING.STATUS.CODE=90&PRESENTATION.CURRENCY=EUR&PAYMENT.CODE=CC.DB&PROCESSING.RETURN.CODE=#{@@success_codes[@mode]}&CONTACT.IP=88.77.23.45&NAME.FAMILY=Longsen&PROCESSING.STATUS=NEW&FRONTEND.CC_LOGO=images%2Fvisa_mc.gif&PRESENTATION.AMOUNT=1.50&IDENTIFICATION.UNIQUEID=8a82944947582925014759da7b6c4387&IDENTIFICATION.TRANSACTIONID=Ruby-RemoteTest+140596179581.7898&IDENTIFICATION.SHORTID=6311.1334.3650&CLEARING.FXRATE=1.0&PROCESSING.TIMESTAMP=2014-07-21+16%3A56%3A36&ADDRESS.COUNTRY=DE&ADDRESS.STATE=BY&RESPONSE.VERSION=1.0&TRANSACTION.MODE=#{@mode}&TRANSACTION.RESPONSE=SYNC&PROCESSING.RETURN=Request+successfully+processed+in+%27Merchant+in+#{@modemsg}+Test+Mode%27&ADDRESS.STREET=Leopoldstr.+1&CLEARING.FXDATE=2014-07-21+16%3A56%3A36&ADDRESS.ZIP=80798")

    response = @gateway.purchase(@amount, @credit_card, @options)
    assert_success response

    assert_equal @@success_messages[@mode], response.message
    assert_equal @@success_codes[@mode], response.params['PROCESSING.RETURN.CODE']
    assert response.test?
  end

  def test_successful_authorize
    @gateway.expects(:ssl_post).returns("PROCESSING.RISK_SCORE=100&P3.VALIDATION=ACK&NAME.GIVEN=Longbob&CLEARING.DESCRIPTOR=6203.8326.5442+activeMerchant+Order+Number+28.006234645843506&PROCESSING.CONNECTORDETAIL.ConnectorTxID3=26K00001&PROCESSING.CONNECTORDETAIL.ConnectorTxID1=265675&TRANSACTION.CHANNEL=channel&PROCESSING.REASON.CODE=00&ADDRESS.CITY=Munich&FRONTEND.REQUEST.CANCELLED=false&PROCESSING.CODE=CC.PA.90.00&PROCESSING.REASON=Successful+Processing&FRONTEND.MODE=DEFAULT&CLEARING.FXSOURCE=INTERN&CLEARING.AMOUNT=1.50&PROCESSING.RESULT=ACK&NAME.SALUTATION=NONE&PRESENTATION.USAGE=Order+Number+28.006234645843506&POST.VALIDATION=ACK&CLEARING.CURRENCY=EUR&FRONTEND.SESSION_ID=&PROCESSING.STATUS.CODE=90&PRESENTATION.CURRENCY=EUR&PAYMENT.CODE=CC.PA&PROCESSING.RETURN.CODE=000.100.112&CONTACT.IP=188.104.86.125&NAME.FAMILY=Longsen&PROCESSING.STATUS=NEW&FRONTEND.CC_LOGO=images%2Fvisa_mc.gif&PRESENTATION.AMOUNT=1.50&IDENTIFICATION.UNIQUEID=8a8294494763d7860147645a29732234&IDENTIFICATION.TRANSACTIONID=Ruby-RemoteTest+140613793600.62546&IDENTIFICATION.SHORTID=6203.8326.5442&CLEARING.FXRATE=1.0&PROCESSING.TIMESTAMP=2014-07-23+17%3A52%3A16&ADDRESS.COUNTRY=DE&ADDRESS.STATE=BY&RESPONSE.VERSION=1.0&TRANSACTION.MODE=#{@mode}&TRANSACTION.RESPONSE=SYNC&PROCESSING.RETURN=Request+successfully+processed+in+%27Merchant+in+#{@modemsg}+Test+Mode%27&ADDRESS.STREET=Leopoldstr.+1&CLEARING.FXDATE=2014-07-23+17%3A52%3A16&ADDRESS.ZIP=80798")

    response = @gateway.authorize(@amount, @credit_card, @options)
    assert_success response

    assert_equal @@success_messages[@mode], response.message
    assert_equal @@success_codes[@mode], response.params['PROCESSING.RETURN.CODE']
    assert response.test?
  end

  def test_successful_capture
    @gateway.expects(:ssl_post).returns("PROCESSING.RISK_SCORE=100&P3.VALIDATION=ACK&NAME.GIVEN=Longbob&CLEARING.DESCRIPTOR=6203.8326.5442+activeMerchant+Order+Number+28.006234645843506&PROCESSING.CONNECTORDETAIL.ConnectorTxID3=26K00001&PROCESSING.CONNECTORDETAIL.ConnectorTxID1=265675&TRANSACTION.CHANNEL=channel&PROCESSING.REASON.CODE=00&ADDRESS.CITY=Munich&FRONTEND.REQUEST.CANCELLED=false&PROCESSING.CODE=CC.PA.90.00&PROCESSING.REASON=Successful+Processing&FRONTEND.MODE=DEFAULT&CLEARING.FXSOURCE=INTERN&CLEARING.AMOUNT=1.50&PROCESSING.RESULT=ACK&NAME.SALUTATION=NONE&PRESENTATION.USAGE=Order+Number+28.006234645843506&POST.VALIDATION=ACK&CLEARING.CURRENCY=EUR&FRONTEND.SESSION_ID=&PROCESSING.STATUS.CODE=90&PRESENTATION.CURRENCY=EUR&PAYMENT.CODE=CC.PA&PROCESSING.RETURN.CODE=000.100.112&CONTACT.IP=188.104.86.125&NAME.FAMILY=Longsen&PROCESSING.STATUS=NEW&FRONTEND.CC_LOGO=images%2Fvisa_mc.gif&PRESENTATION.AMOUNT=1.50&IDENTIFICATION.UNIQUEID=8a8294494763d7860147645a29732234&IDENTIFICATION.TRANSACTIONID=Ruby-RemoteTest+140613793600.62546&IDENTIFICATION.SHORTID=6203.8326.5442&CLEARING.FXRATE=1.0&PROCESSING.TIMESTAMP=2014-07-23+17%3A52%3A16&ADDRESS.COUNTRY=DE&ADDRESS.STATE=BY&RESPONSE.VERSION=1.0&TRANSACTION.MODE=#{@mode}&TRANSACTION.RESPONSE=SYNC&PROCESSING.RETURN=Request+successfully+processed+in+%27Merchant+in+#{@modemsg}+Test+Mode%27&ADDRESS.STREET=Leopoldstr.+1&CLEARING.FXDATE=2014-07-23+17%3A52%3A16&ADDRESS.ZIP=80798")

    response = @gateway.authorize(@amount, @credit_card, @options)
    assert_success response

    assert_equal @@success_messages[@mode], response.message
    assert_equal @@success_codes[@mode], response.params['PROCESSING.RETURN.CODE']
    assert response.test?

    @gateway.expects(:ssl_post).returns("PROCESSING.RISK_SCORE=0&P3.VALIDATION=ACK&CLEARING.DESCRIPTOR=6944.0434.2434+activeMerchant+Order+Number+1094.158102273941&PROCESSING.CONNECTORDETAIL.ConnectorTxID3=26K00001&PROCESSING.CONNECTORDETAIL.ConnectorTxID1=265890&TRANSACTION.CHANNEL=channel&PROCESSING.REASON.CODE=00&PROCESSING.CODE=CC.CP.90.00&FRONTEND.REQUEST.CANCELLED=false&PROCESSING.REASON=Successful+Processing&FRONTEND.MODE=DEFAULT&CLEARING.FXSOURCE=INTERN&CLEARING.AMOUNT=1.50&PROCESSING.RESULT=ACK&NAME.SALUTATION=NONE&POST.VALIDATION=ACK&CLEARING.CURRENCY=EUR&FRONTEND.SESSION_ID=&PROCESSING.STATUS.CODE=90&PRESENTATION.CURRENCY=EUR&PAYMENT.CODE=CC.CP&PROCESSING.RETURN.CODE=000.100.112&CONTACT.IP=188.104.86.125&IDENTIFICATION.REFERENCEID=8a82944a4763d939014764b5e7423710&PROCESSING.STATUS=NEW&FRONTEND.CC_LOGO=images%2Fvisa_mc.gif&PRESENTATION.AMOUNT=1.50&IDENTIFICATION.UNIQUEID=8a82944a4763d939014764b611d5373d&IDENTIFICATION.TRANSACTIONID=Ruby-RemoteTest+140614394815.81253&IDENTIFICATION.SHORTID=6944.0434.2434&CLEARING.FXRATE=1.0&PROCESSING.TIMESTAMP=2014-07-23+19%3A32%3A39&ADDRESS.COUNTRY=DE&RESPONSE.VERSION=1.0&TRANSACTION.MODE=#{@mode}&TRANSACTION.RESPONSE=SYNC&PROCESSING.RETURN=Request+successfully+processed+in+%27Merchant+in+#{@modemsg}+Test+Mode%27&CLEARING.FXDATE=2014-07-23+19%3A32%3A39")

    response = @gateway.capture(nil, {  
      'IDENTIFICATION.UNIQUEID' =>  "8a8294494763d786014764b139373779", 
      'IDENTIFICATION.SHORTID' => "5897.8162.3458", 
      'PRESENTATION.AMOUNT' => "1.50",  
      'PRESENTATION.CURRENCY' => "EUR", 
      'IDENTIFICATION.TRANSACTIONID'  => "Ruby-RemoteTest 140614364124.39487",  
    })
    assert_success response

    assert_equal @@success_messages[@mode], response.message
    assert_equal @@success_codes[@mode], response.params['PROCESSING.RETURN.CODE']
    assert response.test?
  end

  def test_successful_refund
    @gateway.expects(:ssl_post).returns("PROCESSING.RISK_SCORE=100&P3.VALIDATION=ACK&NAME.GIVEN=Longbob&CLEARING.DESCRIPTOR=5028.7564.4578+activeMerchant+Order+Number+1724.1255989074707&PROCESSING.CONNECTORDETAIL.ConnectorTxID3=26K00001&PROCESSING.CONNECTORDETAIL.ConnectorTxID1=266564&TRANSACTION.CHANNEL=channel&PROCESSING.REASON.CODE=00&ADDRESS.CITY=Munich&FRONTEND.REQUEST.CANCELLED=false&PROCESSING.CODE=CC.DB.90.00&PROCESSING.REASON=Successful+Processing&FRONTEND.MODE=DEFAULT&CLEARING.FXSOURCE=INTERN&CLEARING.AMOUNT=1.50&PROCESSING.RESULT=ACK&NAME.SALUTATION=NONE&PRESENTATION.USAGE=Order+Number+1724.1255989074707&POST.VALIDATION=ACK&CLEARING.CURRENCY=EUR&FRONTEND.SESSION_ID=&PROCESSING.STATUS.CODE=90&PRESENTATION.CURRENCY=EUR&PAYMENT.CODE=CC.DB&PROCESSING.RETURN.CODE=000.100.112&CONTACT.IP=94.216.212.194&NAME.FAMILY=Longsen&PROCESSING.STATUS=NEW&FRONTEND.CC_LOGO=images%2Fvisa_mc.gif&PRESENTATION.AMOUNT=1.50&IDENTIFICATION.UNIQUEID=8a8294494763d786014766f58b4b3d2d&IDENTIFICATION.TRANSACTIONID=Ruby-RemoteTest+140618167312.56226&IDENTIFICATION.SHORTID=5028.7564.4578&CLEARING.FXRATE=1.0&PROCESSING.TIMESTAMP=2014-07-24+06%3A01%3A13&ADDRESS.COUNTRY=DE&ADDRESS.STATE=BY&RESPONSE.VERSION=1.0&TRANSACTION.MODE=#{@mode}&TRANSACTION.RESPONSE=SYNC&PROCESSING.RETURN=Request+successfully+processed+in+%27Merchant+in+#{@modemsg}+Test+Mode%27&ADDRESS.STREET=Leopoldstr.+1&CLEARING.FXDATE=2014-07-24+06%3A01%3A13&ADDRESS.ZIP=80798")

    response = @gateway.authorize(@amount, @credit_card, @options)
    assert_success response
    
    @gateway.expects(:ssl_post).returns("P3.VALIDATION=ACK&CLEARING.DESCRIPTOR=0905.5878.4162+activeMerchant+Order+Number+1724.1255989074707&PROCESSING.CONNECTORDETAIL.ConnectorTxID3=26K00001&PROCESSING.CONNECTORDETAIL.ConnectorTxID1=266565&TRANSACTION.CHANNEL=channel&PROCESSING.REASON.CODE=00&PROCESSING.CODE=CC.RF.90.00&FRONTEND.REQUEST.CANCELLED=false&PROCESSING.REASON=Successful+Processing&FRONTEND.MODE=DEFAULT&CLEARING.FXSOURCE=INTERN&CLEARING.AMOUNT=1.00&PROCESSING.RESULT=ACK&NAME.SALUTATION=NONE&POST.VALIDATION=ACK&CLEARING.CURRENCY=EUR&FRONTEND.SESSION_ID=&PROCESSING.STATUS.CODE=90&PRESENTATION.CURRENCY=EUR&PAYMENT.CODE=CC.RF&PROCESSING.RETURN.CODE=000.100.112&CONTACT.IP=94.216.212.194&IDENTIFICATION.REFERENCEID=8a8294494763d786014766f58b4b3d2d&PROCESSING.STATUS=NEW&PRESENTATION.AMOUNT=1.00&FRONTEND.CC_LOGO=images%2Fvisa_mc.gif&IDENTIFICATION.UNIQUEID=8a8294494763d786014766f58efd3d3c&IDENTIFICATION.TRANSACTIONID=Ruby-RemoteTest+140618167312.56226&IDENTIFICATION.SHORTID=0905.5878.4162&CLEARING.FXRATE=1.0&PROCESSING.TIMESTAMP=2014-07-24+06%3A01%3A14&ADDRESS.COUNTRY=DE&RESPONSE.VERSION=1.0&TRANSACTION.MODE=#{@mode}&TRANSACTION.RESPONSE=SYNC&PROCESSING.RETURN=Request+successfully+processed+in+%27Merchant+in+#{@modemsg}+Test+Mode%27&CLEARING.FXDATE=2014-07-24+06%3A01%3A14")

    response = @gateway.refund(nil, {  
      'IDENTIFICATION.UNIQUEID' =>  "8a8294494763d786014766f58b4b3d2d", 
      'IDENTIFICATION.SHORTID' => "5028.7564.4578", 
      'PRESENTATION.AMOUNT' => "1.50",  
      'PRESENTATION.CURRENCY' => "EUR", 
      'IDENTIFICATION.TRANSACTIONID'  => "Ruby-RemoteTest 140614364124.39487",  
    })
    assert_success response

    assert_equal @@success_messages[@mode], response.message
    assert_equal @@success_codes[@mode], response.params['PROCESSING.RETURN.CODE']
    assert response.test?
  end

  def test_successful_void
    @gateway.expects(:ssl_post).returns("")
    response = @gateway.authorize(@amount, @credit_card, @options)
    assert_success response
    assert_equal @@success_messages[@mode], response.message
    assert_equal @@success_codes[@mode], response.params['PROCESSING.RETURN.CODE']
    assert response.test?

    @gateway.expects(:ssl_post).returns("")
    assert void = @gateway.void(response.authorization)
    assert_success void
    @gateway.logger.info("#{__method__.to_s} - message - #{void.message}, code - #{void.params['PROCESSING.RETURN.CODE']}")
    assert_equal @@success_message[@mode], void.message
  end

  def test_failed_authorize
  end
  def test_failed_capture
  end

  def test_failed_refund
  end

  def test_failed_void
  end

  def set_options
      @options['TRANSACTION.MODE'] = @mode
      @options['PRESENTATION.USAGE'] = "Order Number #{Time.now.to_f.divmod(2473)[1]}"
      @options['IDENTIFICATION.TRANSACTIONID'] = "Ruby-RemoteTest #{Time.now.to_f * 100}"
      @options[:address] = {
        :street => "Leopoldstr. 1",
        :zip => "80798",
        :city => "Munich",
        :state => "BY",
        :country => "DE",
      }
  end
end
